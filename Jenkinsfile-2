pipeline {
    agent any
    options{
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: "10"))
        timeout(time: 1, unit: "MINUTES")
    }
    stages {
        stage('Build Docker Image For Tests') {
            steps {
                sh 'docker build --rm -t pipeline-2 .'
            }
        }
        stage('List Of Docker Images') {
            steps {
                sh 'docker images'
            }
        }
        stage('CodeAnalyze And Run Docker'){
            parallel{
                stage("Analyze Files"){
                    steps{
                        robocopy()
                    }
                }
                stage("Run Docker"){
                    steps{
                        sh 'docker run --rm -v ${WORKSPACE}/Results:/app/Results pipeline-2'
                    }
                }
            }
        }
        stage("Results"){
            steps{
                robot archiveDirName: 'robot-plugin', outputPath: 'Results', overwriteXAxisLabel: '', passThreshold: 100.0, unstableThreshold: 100.0
            }
        }
    }
}
    def robocopy(cmd)
    {
        // robocopy uses non-zero exit code even on success, status below 3 is fine
        def status = bat returnStatus: true, script: "ROBOCOPY ${cmd}"
        println "ROBOCOPY returned ${status}"
        if (status < 0 || status > 3)
        {
            error("ROBOCOPY failed")
        }
    }
